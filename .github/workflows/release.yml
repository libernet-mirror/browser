name: Release

on:
  push:
    tags:
      - v*

jobs:
  build:
    name: "Build (${{ matrix.os }}-${{ matrix.arch }})"
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # For the available architectures see
          # https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#standard-github-hosted-runners-for-public-repositories

          - os: linux
            arch: x64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm

          - os: windows
            arch: x64
            runner: windows-latest

          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: macos
            arch: arm64
            runner: macos-15

    permissions:
      contents: write

    steps:
      - name: "Install Clang / LLVM (non-MacOS)"
        if: runner.os != 'macOS'
        uses: egor-tensin/setup-clang@v2
        with:
          version: 18

      - name: Install LLVM (MacOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm@18
          echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH

      - name: Configure WASM C compiler (MacOS)
        if: runner.os == 'macOS'
        run: |
          echo "CC_wasm32_unknown_unknown=clang" >> $GITHUB_ENV
          echo "AR_wasm32_unknown_unknown=llvm-ar" >> $GITHUB_ENV

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: latest
          architecture: ${{ matrix.arch }}

      - name: "Install Rust"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: "Install the wasm-bindgen CLI"
        # NOTE: the version of wasm-bindgen-cli must match *exactly* the version of wasm-bindgen
        # that the crypto crate depends on.
        run: cargo install wasm-bindgen-cli --version 0.2.108

      - name: "Clone the repository"
        uses: actions/checkout@v6
        with:
          ref: main
          submodules: recursive

      - name: "Install Node dependencies"
        run: npm ci

      - name: "Test the crypto submodule"
        working-directory: crypto
        run: cargo test --release

      - name: "Build the crypto submodule"
        working-directory: crypto
        run: cargo build --target wasm32-unknown-unknown --release

      - name: "Generate WASM JS bindings"
        working-directory: crypto
        run: wasm-bindgen target/wasm32-unknown-unknown/release/crypto.wasm --out-dir ../crypto-bindings --target bundler

      - name: "Package the Electron app"
        run: npm run package

      - name: "Make the Electron distributables"
        run: npm run make

      - name: "Normalize artifact filenames (Linux + MacOS)"
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ github.ref_name }}"
          TARGET="${{ matrix.os }}-${{ matrix.arch }}"

          mkdir -p release
          cp LICENSE release/LICENSE

          case "$TARGET" in
            linux-x64|linux-arm64)
              DEB_FILE=$(find out/make -type f -name "*.deb" -print -quit)
              RPM_FILE=$(find out/make -type f -name "*.rpm" -print -quit)

              if [ -n "${DEB_FILE:-}" ]; then
                mv "$DEB_FILE" "release/libernet-browser-${VERSION}-${TARGET}.deb"
              fi

              if [ -n "${RPM_FILE:-}" ]; then
                mv "$RPM_FILE" "release/libernet-browser-${VERSION}-${TARGET}.rpm"
              fi
              ;;
            macos-x64|macos-arm64)
              ZIP_FILE=$(find out/make -type f -name "*.zip" -print -quit)

              if [ -z "${ZIP_FILE:-}" ]; then
                echo "MacOS build artifact not found"
                exit 1
              fi

              mv "$ZIP_FILE" "release/libernet-browser-${VERSION}-${TARGET}.zip"
              ;;
          esac

          echo "Final release contents:"
          ls -l release

      - name: Normalize artifact filenames (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"

          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item -Path LICENSE -Destination release\LICENSE -Force

          $exe = Get-ChildItem -Recurse -Filter *.exe |
                 Where-Object { $_.FullName -like "*out\make*" } |
                 Select-Object -First 1

          if (-not $exe) { throw "No .exe installer found" }
          Move-Item $exe.FullName "release\libernet-$version-windows-x64.exe"

          $nupkg = Get-ChildItem -Recurse -Filter *.nupkg |
                   Where-Object { $_.FullName -like "*out\make*" } |
                   Select-Object -First 1

          if (-not $nupkg) { throw "No .nupkg file found" }
          Move-Item $nupkg.FullName "release\libernet-$version-windows-x64.nupkg"

          Write-Host "Final release contents:"
          Get-ChildItem release

      - name: "Upload the build artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.os }}-${{ matrix.arch }}
          path: release/*
          overwrite: true

  release:
    name: "Release"
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: write

    steps:
      - name: "Download all build artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "Display structure"
        run: ls -Ral artifacts

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          files: artifacts/**/*
          overwrite_files: true
          make_latest: true
